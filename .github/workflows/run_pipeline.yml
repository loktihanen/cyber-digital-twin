name: ğŸ“¦ Run Cyber Digital Twin Pipeline

on:
  schedule:
    - cron: '0 4 * * *'  # Tous les jours Ã  4h UTC
  workflow_dispatch:       # Lancement manuel
  push:
    branches: [ main ]
    paths:
      - 'cskg/**'
      - 'digital_twin/**'
      - '.github/workflows/run_pipeline.yml'

jobs:
  build:
    name: âš™ï¸ Pipeline Digital Twin Complet
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v3

      - name: ğŸ§± Installer dÃ©pendances systÃ¨me (GraphViz etc.)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libcairo2-dev \
            libpango1.0-dev \
            libgdk-pixbuf2.0-dev \
            libffi-dev \
            graphviz \
            build-essential

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Installer les dÃ©pendances Python
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: âš™ï¸ ExÃ©cuter KG1 (NVD)
        run: |
          cd $GITHUB_WORKSPACE
          python cskg/collect_nvd.py

      - name: âš™ï¸ ExÃ©cuter KG2 (Nessus)
        run: |
          cd $GITHUB_WORKSPACE
          python cskg/inject_nessus.py

      - name: ğŸ”„ Alignement & Fusion
        run: |
          cd $GITHUB_WORKSPACE
          python cskg/align_and_merge.py
          python cskg/propagate_impacts.py

      - name: ğŸ§  Embeddings & GNN
        run: |
          cd $GITHUB_WORKSPACE
          python cskg/embeddings_train.py
          python cskg/r_gcn_predict.py

      - name: ğŸ“Š GÃ©nÃ©rer visualisations
        run: |
          cd $GITHUB_WORKSPACE
          python cskg/visualization.py

  monitor-nvd:
    name: ğŸ” Monitoring NVD (Nouveaux CVE)
    runs-on: ubuntu-latest
    needs: build  # ExÃ©cuter aprÃ¨s le job principal

    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v3

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Installer les dÃ©pendances Python
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ” Lancer le script de monitoring
        run: |
          cd $GITHUB_WORKSPACE
          python digital_twin/monitor.py
